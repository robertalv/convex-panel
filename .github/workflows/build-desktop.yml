name: Build Desktop App

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., 0.1.0)"
        required: false
        default: ""

env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

jobs:
  build-macos:
    # Use macos-15 for latest SDK compatibility
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        target: [aarch64-apple-darwin, x86_64-apple-darwin]
        include:
          - target: aarch64-apple-darwin
            arch: arm64
          - target: x86_64-apple-darwin
            arch: x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select latest Xcode
        run: |
          # List available Xcode versions and select the latest
          ls -la /Applications/ | grep Xcode
          LATEST_XCODE=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          if [ -n "$LATEST_XCODE" ]; then
            echo "Selecting Xcode: $LATEST_XCODE"
            sudo xcode-select -s "$LATEST_XCODE/Contents/Developer"
          fi
          xcodebuild -version
          xcrun --show-sdk-path
          xcrun --show-sdk-version

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri -> target

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm --filter @convex-panel/shared build && pnpm --filter @convex-panel/registry build && pnpm --filter convex-panel build

      - name: Import Apple certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "No APPLE_CERTIFICATE secret found, skipping certificate import"
            exit 0
          fi

          echo "Importing Apple certificate..."
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12

          # Create and configure keychain
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Import certificate
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          # Allow codesign to access the keychain without prompting
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain

          # Verify the certificate was imported
          security find-identity -v build.keychain | head -5

          rm certificate.p12
          echo "Certificate import complete"

      - name: Build Tauri app
        timeout-minutes: 30
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # Apple Notarization - requires app-specific password from appleid.apple.com
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # API URL for production
          VITE_API_URL: https://api.convexpanel.dev
        with:
          projectPath: apps/desktop
          args: --target ${{ matrix.target }}

      - name: Staple notarization ticket
        if: ${{ env.APPLE_ID != '' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
        run: |
          echo "Stapling notarization ticket to DMG..."
          DMG_PATH=$(find apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg -name "*.dmg" 2>/dev/null | head -1)

          if [ -n "$DMG_PATH" ]; then
            echo "Found DMG: $DMG_PATH"
            
            # Wait for notarization to complete (it may still be processing)
            echo "Waiting for notarization to complete..."
            for i in {1..30}; do
              if xcrun stapler staple "$DMG_PATH" 2>&1; then
                echo "✅ Successfully stapled notarization ticket to DMG"
                break
              else
                echo "Attempt $i: Notarization not ready yet, waiting 10 seconds..."
                sleep 10
              fi
            done
            
            # Verify the staple was successful
            if xcrun stapler validate "$DMG_PATH" 2>/dev/null; then
              echo "✅ DMG notarization verified successfully"
            else
              echo "⚠️ Warning: Could not verify DMG stapling"
            fi
            
            # Also staple the app bundle
            APP_PATH=$(find apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.app" 2>/dev/null | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "Stapling app bundle: $APP_PATH"
              xcrun stapler staple "$APP_PATH" || echo "Note: App stapling may have already been done"
            fi
          else
            echo "No DMG found to staple"
          fi

      - name: Verify notarization
        if: ${{ env.APPLE_ID != '' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
        run: |
          echo "Verifying notarization status..."
          DMG_PATH=$(find apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg -name "*.dmg" 2>/dev/null | head -1)
          APP_PATH=$(find apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.app" 2>/dev/null | head -1)

          if [ -n "$DMG_PATH" ]; then
            echo "Checking DMG: $DMG_PATH"
            xcrun stapler validate "$DMG_PATH" && echo "✅ DMG: Notarization ticket valid" || echo "❌ DMG: No valid ticket"
          fi

          if [ -n "$APP_PATH" ]; then
            echo "Checking App: $APP_PATH"
            spctl -a -vv "$APP_PATH" 2>&1 || true
          fi

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: Convex-Panel-macos-${{ matrix.arch }}
          path: |
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
          if-no-files-found: error

      - name: Upload app bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: Convex-Panel-macos-${{ matrix.arch }}-app
          path: |
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri -> target

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm --filter @convex-panel/shared build && pnpm --filter @convex-panel/registry build

      - name: Build convex-panel (sequential to avoid esbuild deadlock)
        run: pnpm --filter convex-panel run build:sequential
        shell: pwsh

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # API URL for production
          VITE_API_URL: https://api.convexpanel.dev
        with:
          projectPath: apps/desktop

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: Convex-Panel-windows-x64
          path: |
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri -> target

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm --filter @convex-panel/shared build && pnpm --filter @convex-panel/registry build && pnpm --filter convex-panel build

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # API URL for production
          VITE_API_URL: https://api.convexpanel.dev
        with:
          projectPath: apps/desktop

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Convex-Panel-linux-x64
          path: |
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            apps/desktop/src-tauri/target/release/bundle/deb/*.deb
          if-no-files-found: warn

  create-release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f -name "*" | head -50

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.AppImage
            artifacts/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
