name: Build Desktop App

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., 0.1.0)"
        required: false
        default: ""

env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

jobs:
  build-macos:
    # Use macos-15 for latest SDK compatibility
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        target: [aarch64-apple-darwin, x86_64-apple-darwin]
        include:
          - target: aarch64-apple-darwin
            arch: arm64
          - target: x86_64-apple-darwin
            arch: x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select latest Xcode
        run: |
          # List available Xcode versions and select the latest
          ls -la /Applications/ | grep Xcode
          LATEST_XCODE=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          if [ -n "$LATEST_XCODE" ]; then
            echo "Selecting Xcode: $LATEST_XCODE"
            sudo xcode-select -s "$LATEST_XCODE/Contents/Developer"
          fi
          xcodebuild -version
          xcrun --show-sdk-path
          xcrun --show-sdk-version

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri -> target

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm --filter @convex-panel/shared build && pnpm --filter @convex-panel/registry build && pnpm --filter convex-panel build

      - name: Import Apple certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "No APPLE_CERTIFICATE secret found, skipping certificate import"
            exit 0
          fi

          echo "Importing Apple certificate..."
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12

          # Create and configure keychain
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Import certificate
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          # Allow codesign to access the keychain without prompting
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain

          # Verify the certificate was imported
          security find-identity -v build.keychain | head -5

          rm certificate.p12
          echo "Certificate import complete"

      - name: Build Tauri app
        timeout-minutes: 30
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # Apple Notarization - requires app-specific password from appleid.apple.com
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # API URL for production
          VITE_API_URL: https://api.convexpanel.dev
        with:
          projectPath: apps/desktop
          args: --target ${{ matrix.target }}

      - name: Staple and verify notarization
        if: ${{ secrets.APPLE_ID != '' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -e

          APP_PATH=$(find apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.app" 2>/dev/null | head -1)
          DMG_PATH=$(find apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg -name "*.dmg" 2>/dev/null | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "❌ No .app found"
            exit 1
          fi

          echo "Found App: $APP_PATH"
          echo "Found DMG: $DMG_PATH"

          # Step 1: Staple the app bundle (wait for notarization to propagate)
          echo "Stapling notarization ticket to app bundle..."
          for i in {1..30}; do
            if xcrun stapler staple "$APP_PATH" 2>&1; then
              echo "✅ Successfully stapled app bundle"
              break
            else
              echo "Attempt $i: Waiting for notarization to propagate..."
              sleep 10
            fi
          done

          # Verify app stapling
          if ! xcrun stapler validate "$APP_PATH" 2>/dev/null; then
            echo "❌ App stapling failed - notarization may not have completed"
            exit 1
          fi

          echo "✅ App notarization verified"

          # Step 2: Check code signature
          echo "Verifying code signature..."
          codesign -dv --verbose=2 "$APP_PATH" 2>&1 || true
          spctl -a -vv "$APP_PATH" 2>&1 || true

          # Step 3: Notarize and staple the DMG separately
          if [ -n "$DMG_PATH" ]; then
            echo "Notarizing DMG..."
            
            # Submit DMG for notarization
            xcrun notarytool submit "$DMG_PATH" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait \
              --timeout 30m
            
            echo "Stapling DMG..."
            xcrun stapler staple "$DMG_PATH"
            
            # Verify DMG stapling
            if xcrun stapler validate "$DMG_PATH" 2>/dev/null; then
              echo "✅ DMG notarization verified"
            else
              echo "⚠️ DMG stapling could not be verified"
            fi
          fi

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: Convex-Panel-macos-${{ matrix.arch }}
          path: |
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
          if-no-files-found: error

      - name: Upload app bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: Convex-Panel-macos-${{ matrix.arch }}-app
          path: |
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri -> target

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm --filter @convex-panel/shared build && pnpm --filter @convex-panel/registry build

      - name: Build convex-panel (sequential to avoid esbuild deadlock)
        run: pnpm --filter convex-panel run build:sequential
        shell: pwsh

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # API URL for production
          VITE_API_URL: https://api.convexpanel.dev
        with:
          projectPath: apps/desktop

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: Convex-Panel-windows-x64
          path: |
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri -> target

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm --filter @convex-panel/shared build && pnpm --filter @convex-panel/registry build && pnpm --filter convex-panel build

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # API URL for production
          VITE_API_URL: https://api.convexpanel.dev
        with:
          projectPath: apps/desktop

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Convex-Panel-linux-x64
          path: |
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            apps/desktop/src-tauri/target/release/bundle/deb/*.deb
          if-no-files-found: warn

  create-release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      arm64_sha: ${{ steps.checksums.outputs.arm64_sha }}
      x64_sha: ${{ steps.checksums.outputs.x64_sha }}
    steps:
      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f -name "*" | head -50

      - name: Calculate SHA256 checksums
        id: checksums
        run: |
          ARM64_DMG=$(find artifacts -name "*aarch64*.dmg" -o -name "*arm64*.dmg" | head -1)
          X64_DMG=$(find artifacts -name "*x64*.dmg" -o -name "*x86_64*.dmg" | head -1)

          if [ -n "$ARM64_DMG" ]; then
            ARM64_SHA=$(shasum -a 256 "$ARM64_DMG" | awk '{print $1}')
            echo "arm64_sha=$ARM64_SHA" >> $GITHUB_OUTPUT
            echo "ARM64 SHA256: $ARM64_SHA"
          fi

          if [ -n "$X64_DMG" ]; then
            X64_SHA=$(shasum -a 256 "$X64_DMG" | awk '{print $1}')
            echo "x64_sha=$X64_SHA" >> $GITHUB_OUTPUT
            echo "x64 SHA256: $X64_SHA"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.AppImage
            artifacts/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: [create-release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Update Homebrew Cask
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          ARM64_SHA="${{ needs.create-release.outputs.arm64_sha }}"
          X64_SHA="${{ needs.create-release.outputs.x64_sha }}"

          echo "Updating Homebrew cask to version $VERSION"
          echo "ARM64 SHA: $ARM64_SHA"
          echo "x64 SHA: $X64_SHA"

          # Generate the new cask content
          CASK_CONTENT=$(cat <<EOF
          cask "convex-panel" do
            version "$VERSION"

            if Hardware::CPU.arm?
              sha256 "$ARM64_SHA"
              url "https://github.com/robertalv/convex-panel/releases/download/v#{version}/Convex.Panel_#{version}_aarch64.dmg"
            else
              sha256 "$X64_SHA"
              url "https://github.com/robertalv/convex-panel/releases/download/v#{version}/Convex.Panel_#{version}_x64.dmg"
            end

            name "Convex Panel"
            desc "Debugging and monitoring tool for Convex applications"
            homepage "https://convexpanel.dev"

            livecheck do
              url :url
              strategy :github_latest
            end

            app "Convex Panel.app"

            zap trash: [
              "~/Library/Application Support/dev.convexpanel.desktop",
              "~/Library/Caches/dev.convexpanel.desktop",
              "~/Library/Preferences/dev.convexpanel.desktop.plist",
              "~/Library/Saved Application State/dev.convexpanel.desktop.savedState",
            ]
          end
          EOF
          )

          # Get current file SHA
          CURRENT_SHA=$(curl -s -H "Authorization: token $HOMEBREW_TAP_TOKEN" \
            "https://api.github.com/repos/robertalv/homebrew-tap/contents/Casks/convex-panel.rb" | \
            jq -r '.sha')

          # Update the file via GitHub API
          curl -X PUT \
            -H "Authorization: token $HOMEBREW_TAP_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/robertalv/homebrew-tap/contents/Casks/convex-panel.rb" \
            -d "$(jq -n \
              --arg message "Update convex-panel to v$VERSION" \
              --arg content "$(echo "$CASK_CONTENT" | base64 -w 0)" \
              --arg sha "$CURRENT_SHA" \
              '{message: $message, content: $content, sha: $sha}')"

          echo "✅ Homebrew cask updated to v$VERSION"
